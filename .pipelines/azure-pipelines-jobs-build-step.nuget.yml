parameters:
  - name: artifactPackages
    type: object
    default: {}

steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: 'src'
      downloadPath: '$(System.DefaultWorkingDirectory)'

  - ${{ each ap in parameters.ArtifactPackages }}:
    - task: ExtractFiles@1
      displayName: 'Extracting ${{ap}}.zip ..'
      inputs:
        archiveFilePatterns: '**/${{ap}}.zip'
        destinationFolder: '$(System.DefaultWorkingDirectory)\src'
        cleanDestinationFolder: false 
        overwriteExistingFiles: true

  - task: DotNetCoreCLI@2
    condition: succeeded()
    displayName: 'Restore Dependencies'
    inputs:
      command: restore
      projects: |
        src/**/*.csproj

  - task: DotNetCoreCLI@2
    condition: succeeded()
    displayName: 'Generate NuGet Packages'
    inputs:
      command: pack
      packagesToPack: src/**/*.csproj
      nobuild: true

  - task: PublishBuildArtifacts@1
    condition: succeeded()
    displayName: 'Store NuGet Packages - $(ArtifactPackageName)'
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)
      artifactName: $(ArtifactPackageName)
      publishLocation: 'Container'