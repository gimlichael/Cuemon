trigger:
- development

variables:
  BuildSource: 'src'
  BuildPlatform: 'Any CPU'
  BuildConfiguration: 'Release'

jobs:
- job: CI
  timeoutInMinutes: 360

  pool:
    vmImage: 'windows-2019'

  steps:
  - task: UseDotNet@2
    displayName: 'Use .Net Core SDK 2.2.207 (SonarCloud)'
    inputs:
      version: 2.2.207

  - task: UseDotNet@2
    displayName: 'Use .Net Core 3.1.401'
    inputs:
      version: 3.1.401

  - task: DotNetCoreCLI@2
    displayName: 'Install NBGV tool'
    inputs:
      command: custom
      custom: tool
      arguments: 'install --global nbgv'

  - script: 'nbgv cloud'
    displayName: 'Set Version using NBGV'

  - task: DownloadSecureFile@1
    displayName: 'Download cuemon.snk'
    inputs:
      secureFile: 'cuemon.snk'

  - task: CopyFiles@2
    displayName: 'Copy cuemon.snk to $(System.DefaultWorkingDirectory)'
    inputs:
      SourceFolder: '$(Agent.TempDirectory)'
      Contents: cuemon.snk
      TargetFolder: '$(System.DefaultWorkingDirectory)'

  - task: DotNetCoreCLI@2
    displayName: Restore
    inputs:
      command: restore
      projects: '**/*.csproj'

  - task: SonarCloudPrepare@1
    displayName: 'Prepare Analysis on SonarCloud'
    inputs:
      SonarCloud: 'Cuemon-SonarCloud'
      organization: 'geekle'
      scannerMode: 'MSBuild'
      projectKey: 'Cuemon'
      projectName: 'Cuemon'
      projectVersion: '$(GitAssemblyInformationalVersion)'

  - task: DotNetCoreCLI@2
    displayName: 'Build and Pack Assemblies'
    inputs:
      command: pack
      packagesToPack: 'src/**/*.csproj'
      configuration: '$(BuildConfiguration)'
      packDirectory: '$(Build.ArtifactStagingDirectory)/artifacts'
      verbosityPack: Minimal

  - task: DotNetCoreCLI@2
    displayName: Test
    inputs:
      command: test
      projects: 'test/**/*.csproj'
      arguments: '--configuration $(BuildConfiguration) --collect "Code coverage"'

  - task: SonarCloudAnalyze@1
    displayName: 'Run Sonar Cloud Code Analysis'

  - task: SonarCloudPublish@1
    displayName: 'Publish Quality Gate Result to Sonar Cloud'
    inputs:
      pollingTimeoutSec: '300'

  - publish: $(Build.ArtifactStagingDirectory)\artifacts
    displayName: 'Publish Artifacts (Nuget)'
    artifact: BuildPackages